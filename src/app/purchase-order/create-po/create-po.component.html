<form [formGroup]="purchaseForm" class="create-po-tbl" (ngSubmit)="onSubmit($event)" (keydown)="prevent_enter($event)">
  <mat-card class="header-main-content">
    <div fxLayout="row">
      <div fxFlex="32.5%" fxFlex.md="37.5%" fxFlex.sm="40%" class="breadcrumb-content">
        <mat-icon class="material-icons" [routerLink]="['/purchaseorder/po-list']">
          keyboard_arrow_left
        </mat-icon><label class="lable"><a [routerLink]="['/purchaseorder/po-list']"> Purchase Receive</a></label>
      </div>
      <div fxFlex="35%" fxFlex.md="25%" fxFlex.sm="20%" class="breadcrumb-header-content">
        Receive Purchase Order
      </div>
      <div fxFlex="32.5%" fxFlex.md="37.5%" fxFlex.sm="40%" class="breadcrumb-btn-content">

        <!-- <button type="button" class="import-doc-btn import-btn" (click)="fileInput.click()"> IMPORT PO</button> -->
        <button type="button" class="import-doc-btn1 import-btn" (click)="saveDraft()" *ngIf="!importSheet"> SAVE
          DRAFT</button>
        <span
          *ngIf="(this.purchaseForm.controls?.noncannabisProducts?.value.length > 0 || this.purchaseForm.controls?.cannabisProductsAccessories?.value.length > 0) && !isImported">
          <mat-bar-button type="submit" [options]="barButtonOptions"></mat-bar-button>
        </span>
        <!-- if import file -->
        <span *ngIf="isImported">
          <mat-bar-button type="submit" [options]="barButtonOptions"></mat-bar-button>
        </span>
        <!-- if import file -->
      </div>
    </div>
  </mat-card>
  <input type="file" hidden #fileInput (change)="uploadFile($event)" />
  <mat-tab-group [selectedIndex]="utility.indexofTab" class="custom-tab">
    <mat-tab>
      <ng-template mat-tab-label>
        <p (click)="utility.scrollTo('section1')">INFORMATION</p>
      </ng-template>
    </mat-tab>
    <mat-tab *ngIf="!isImported">
      <ng-template mat-tab-label>
        <p (click)="utility.scrollTo('section2')">PRODUCTS</p>
      </ng-template>
    </mat-tab>
    <mat-tab *ngIf="isImported">
      <ng-template mat-tab-label>
        <p (click)="utility.scrollTo('section3')">PRODUCTS</p>
      </ng-template>
    </mat-tab>
  </mat-tab-group>

  <div class="main-div-container create-po">
    <div fxLayout="row">
      <div fxFlex="100" class="scroll-container fancyscroll view-module" id="parentDiv" scrollSpy [spiedTags]="['DIV']"
        (sectionChange)="utility.onScrollContent($event)" [style.height.px]="innerHeight">
        <div id="section1">
          <div class="section-content" fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="0.5%"
            fxLayoutAlign="center">
            <div fxFlex="2" fxFlex.md="2" fxFlex.sm="5" fxFlex.xs="10%">
            </div>
            <div fxFlex="96" fxFlex.sm="75" fxFlex.md="96" fxFlex.xs="80%">
              <div class="">
                <h2 layout-margin>Purchase Receive Information</h2>
                <mat-card class="body-card-block">
                  <mat-card-content>
                    <div fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="3%">
                      <div fxFlex="31%">
                        <mat-form-field fxFlex="100%">
                          <input matInput placeholder="PO Number"
                            [formControl]="purchaseForm.controls['purchase_order_no']" [readonly]="isImported"
                            autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['purchase_order_no'].hasError('required')">Please
                            enter PO number for reference</mat-error>
                          <mat-error *ngIf="purchaseForm.controls['purchase_order_no'].errors?.asyncValidation">The
                            purchase order no has already been taken</mat-error>
                          <!-- <span class="mat-text-warn" *ngIf="isPOnumber">The purchase order no has already been taken.</span> -->
                        </mat-form-field>
                      </div>
                      <div fxFlex="31%">
                        <mat-form-field fxFlex="100%">
                          <input matInput [matDatepicker]="picker" [readonly]="isImported" (focus)="picker.open()"
                            [max]="maxDate" [min]="minDate" [readonly]="true" (click)="picker.open()"
                            placeholder="Invoice Date" [formControl]="purchaseForm.controls['invoice_date']">
                          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                          <mat-datepicker #picker></mat-datepicker>
                          <mat-error *ngIf="purchaseForm.controls['invoice_date'].hasError('required')">Please enter
                            invoice date</mat-error>
                        </mat-form-field>
                      </div>
                      <div fxFlex="31%">
                        <mat-form-field fxFlex="100%">
                        <!-- <mat-form-field fxFlex="100%" *ngIf="!isImported"> -->
                          <mat-select [formControl]="purchaseForm.controls['storage_id']"
                            placeholder="Inventory Import Location" [disableOptionCentering]="true">
                            <mat-option (onSelectionChange)="taxrate(wh.store_id,wh.chain_id, $event)"
                              *ngFor="let wh of warehouse" [value]="wh.storage_id">{{ wh.name }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                    </div>

                    <div fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="3%">
                      <div fxFlex="31%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput [formControl]="purchaseForm.controls['vendor_id']" placeholder="Vendor"
                            *ngIf="isImported" [readonly]="isImported" autocomplete="off">

                          <mat-select placeholder="Vendor" *ngIf="!isImported"
                            [formControl]="purchaseForm.controls['vendor_id']" [disableOptionCentering]="true">
                            <mat-option>Select Vendor</mat-option>
                            <mat-option *ngFor="let vendor of rawData?.vendors" [value]="vendor.vendor_id">
                              {{vendor.name}}
                            </mat-option>
                          </mat-select>
                          <mat-error *ngIf="purchaseForm.controls['vendor_id'].hasError('required')">Please select
                            vendor</mat-error>
                        </mat-form-field>
                      </div>
                      <div fxFlex="65%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="Address" [readonly]="isImported"
                            [formControl]="purchaseForm.controls['address']" autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['address'].hasError('required')">Please
                            enter address</mat-error>
                        </mat-form-field>
                      </div>
                    </div>

                    <div fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="3%">
                      <div fxFlex="31%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="Contact Person" [readonly]="isImported"
                            [formControl]="purchaseForm.controls['contact']" autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['contact'].hasError('required')">Please
                            enter contact details</mat-error>
                        </mat-form-field>
                      </div>
                      <div fxFlex="31%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="Phone" [readonly]="isImported"
                            [formControl]="purchaseForm.controls['phone']" autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['phone'].hasError('required')">Please
                            enter phone number</mat-error>
                        </mat-form-field>
                      </div>
                      <div fxFlex="31%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="Email" [readonly]="isImported"
                            [formControl]="purchaseForm.controls['email']" autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['email'].hasError('required')">Please
                            enter email</mat-error>
                        </mat-form-field>
                      </div>
                    </div>

                    <div fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="2%">
                      <div fxFlex="15%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="Sum of Purchase Price($)" type="text" currencyMask
                            [options]="options" [readonly]="true" maxlength='15'
                            [formControl]="purchaseForm.controls['total']" autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['total'].hasError('required')">Please enter total
                            amount of purchase receive</mat-error>
                        </mat-form-field>
                      </div>
                      <!-- Tax rate drop down -->
                      <div fxFlex="15%">
                        <mat-form-field fxFlex="100%" *ngIf="!isImported" class="input-align">
                          <mat-select placeholder="Tax rate" [formControl]="purchaseForm.controls['taxrate_id']"
                            [disableOptionCentering]="true">
                            <mat-option (onSelectionChange)="tax_rate_none()">Choose an option</mat-option>
                            <mat-option *ngFor="let tax_rate of tax_rate" [value]="tax_rate.id"
                              (onSelectionChange)="current_taxrate(tax_rate, $event)">
                              {{tax_rate.tax_type}}({{tax_rate.provincial_rate>0 ? tax_rate.country_rate +" + "+ tax_rate.provincial_rate : tax_rate.country_rate}})
                            </mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                      <!-- Tax rate drop down -->
                      <div fxFlex="15%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="GST Amount($)"
                            [readonly]="purchaseForm.controls['total'].value === 0" type="text" currencyMask
                            [options]="options" maxlength='15'
                            [formControl]="purchaseForm.controls['country_tax_amount']" autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['country_tax_amount'].hasError('required')">Please
                            enter GST amount of purchase receive</mat-error>
                        </mat-form-field>
                      </div>
                      <div fxFlex="15%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="PST Amount($)"
                            [readonly]="purchaseForm.controls['total'].value === 0" type="text" currencyMask
                            [options]="options" maxlength='15'
                            [formControl]="purchaseForm.controls['provincial_tax_amount']" autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['provincial_tax_amount'].hasError('required')">Please
                            enter PST amount of purchase receive</mat-error>
                        </mat-form-field>
                      </div>
                      <div fxFlex="15%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="Freight Amount($)" [readonly]="isImported" type="text"
                            currencyMask [options]="options" maxlength='15'
                            [formControl]="purchaseForm.controls['freight_charge']" autocomplete="off">
                          <mat-error *ngIf="purchaseForm.controls['freight_charge'].hasError('required')">Please enter
                            amount of freight amount</mat-error>
                        </mat-form-field>
                      </div>
                      <div fxFlex="14%">
                        <mat-form-field fxFlex="100%" class="input-align">
                          <input matInput placeholder="Total" type="text" currencyMask [options]="options"
                            [readonly]="true" maxlength='15' [formControl]="purchaseForm.controls['final_total']"
                            autocomplete="off">
                          <!-- <mat-error *ngIf="purchaseForm.controls['final_total'].hasError('required')">Please enter total
                            amount of purchase receive</mat-error> -->
                        </mat-form-field>
                      </div>
                    </div>

                    <div fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="3%">

                    </div>

                    <div fxLayout="row">
                      <div fxFlex="100%">
                        <mat-form-field fxFlex="100%">
                          <textarea matInput placeholder="Notes" [formControl]="purchaseForm.controls['description']"
                            autocomplete="off"></textarea>
                          <mat-error *ngIf="purchaseForm.controls['description'].hasError('required')">Please include
                            notes</mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                    <hr>
                    <h3>Documents</h3>
                    <mat-card class="file-drop-box po-document" (click)="fileUpload.click()" ng2FileDrop
                      [ngClass]="{'nv-file-over': hasBaseDropZoneOver}" (fileOver)="fileOverBase($event,'documents')"
                      [uploader]="uploader">
                      <div class="mb-1 drag_upload">Browse or drag file(s) to upload</div>
                    </mat-card>
                    <input hidden #fileUpload type="file" multiple [formControl]="purchaseForm.controls['file_input']"
                      ng2FileDrop [ngClass]="{'nv-file-over': hasBaseDropZoneOver}"
                      (change)="fileOverBase($event,'documents')" ng2FileSelect [uploader]="uploader" />
                    <mat-card class="po-document" *ngFor="let file of arrayOfFiles ; let i = index">
                      <div fxLayout="row" class="file-view-section">
                        <div fxFlex="15%">
                          <mat-icon class="material-icons">
                            attachment
                          </mat-icon>
                        </div>
                        <div fxFlex="70%">{{file.original_name}}</div>
                        <div fxFlex="15%" class="end">
                          <mat-icon class="material-icons pointer" (click)="deleteFile(i)">
                            delete
                          </mat-icon>
                        </div>
                      </div>
                      <hr>
                    </mat-card>

                  </mat-card-content>

                </mat-card>
              </div>
            </div>
            <div fxFlex="2" fxFlex.sm="20" fxFlex.md="2" fxFlex.xs="10%">
            </div>
          </div>
        </div>
        <div id="section2" *ngIf="!isImported">
          <div class="section-content" fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="0.5%"
            fxLayoutAlign="center">
            <div fxFlex="2" fxFlex.md="2" fxFlex.sm="5" fxFlex.xs="10%">
            </div>
            <div fxFlex="96" fxFlex.sm="75" fxFlex.md="96" fxFlex.xs="80%">
              <div class="">
                <h2 layout-margin>Products</h2>
                <mat-card class="">
                  <mat-card-content>
                    <!-- <div fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="5%" fxLayoutAlign="end">
                      <div class="" fxFlex="50%">
                        <mat-form-field fxFlex="100%">
                          <mat-select [formControl]="purchaseForm.controls['storage_id']" placeholder="Warehouse"
                            [disableOptionCentering]="true">
                            <mat-option *ngFor="let wh of warehouse" [value]="wh">{{ wh.name }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                    </div> -->

                    <div fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="2%" fxLayoutAlign="center">
                      <div class="" fxFlex="65%">
                        <mat-form-field fxFlex="100%">
                          <input matInput placeholder="ADD PRODUCTS TO ORDER"
                            [formControl]="purchaseForm.controls['search']" [matAutocomplete]="auto" #searchInput
                            (input)="selected_result(purchaseForm.controls['search'].value)">
                          <mat-autocomplete #auto="matAutocomplete" [displayWith]="productDisplay">
                            <mat-option *ngFor="let option of productData" [value]="option"
                              (onSelectionChange)="selected_result(option)">
                              {{option.variant_sku+" - "+option.product_name+" - "+option.variant_name}}
                            </mat-option>
                          </mat-autocomplete>
                          <mat-error *ngIf="purchaseForm.controls['search'].hasError('required')">Please
                            enter PO number for reference</mat-error>
                        </mat-form-field>
                      </div>
                      <div class="margin-top-10" fxFlex="30%">
                        <div fxLayoutGap="row" fxLayoutGap="5%">
                          <!-- <button type="button" mat-button color="primary"
                            (click)="isScanning = !isScanning;focusOnSearch()"
                            [ngClass]="{'scan-inactive':isScanning !=true}" class="dialog-button button-padding"
                            fxFlex="47.5%">
                            <mat-icon class="report-header-button">view_column</mat-icon>
                            Scan
                          </button> -->
                          <button type="button" mat-button color="primary" class="dialog-button button-padding"
                            fxFlex="47.5%" (click)="add_product('','by_search')" [disabled]="!selectedResult">
                            <mat-icon class="report-header-button">add</mat-icon>
                            Add
                          </button>
                          <button type="button" mat-button color="primary" class="dialog-button button-padding"
                            fxFlex="47.5%" (click)="add_new_product()" [disabled]="selectedResult">
                            <mat-icon class="report-header-button">add</mat-icon>
                            New
                          </button>
                        </div>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>
            </div>
            <div fxFlex="2" fxFlex.sm="20" fxFlex.md="2" fxFlex.xs="10%">
            </div>
          </div>
        </div>

        <!------------------------- Product Data ---------------------->
        <div id="section3" *ngIf="this.purchaseForm.controls?.poProducts?.value.length > 0">
          <div class="section-content" fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="0.5%"
            fxLayoutAlign="center">
            <div fxFlex="2" fxFlex.md="2" fxFlex.sm="5" fxFlex.xs="0">
            </div>
            <div fxFlex="96" fxFlex.sm="92.5" fxFlex.md="96">
              <div class="" formArrayName="poProducts">
                <h2 layout-margin>Products</h2>
                <mat-card style="padding:0px;">
                  <div fxLayout="row" class="import-file-success" *ngIf="isTrue">
                    <div class="error-icon">
                      <mat-icon class="material-icons">
                        warning
                      </mat-icon>
                    </div>
                    <h3>Selling price must be input above $0.00 to be displayed on the POS</h3>
                    <span fxFlex></span>
                    <div class="close-icon" (click)="isTrue = false">
                      <mat-icon class="material-icons">
                        cancel
                      </mat-icon>
                    </div>
                  </div>
                  <div class="import-po-table">
                    <ngx-datatable #myDatatable class="material product_table" [headerHeight]="60"
                      [ngStyle]="{'height':dynamicHeight}" [limit]="10" [columnMode]="'force'" [scrollbarH]="true"
                      [footerHeight]="0" [rowHeight]="48" [scrollbarV]="true"
                      [rows]="this.purchaseForm.controls.poProducts.value">

                      <ngx-datatable-column name="" [frozenLeft]="true" [sortable]="false" [draggable]="false"
                        [resizeable]="false" [width]="80" [maxWidth]="60" [minWidth]="50">
                        <ng-template ngx-datatable-header-template let-allRowsSelected="allRowsSelected"
                          let-selectFn="selectFn">
                        </ng-template>
                        <ng-template ngx-datatable-cell-template ngx-datatable-cell-template let-row="row"
                          let-expanded="expanded" let-value="value" let-rowIndex="rowIndex" let-isSelected="isSelected"
                          let-onCheckboxChangeFn="onCheckboxChangeFn">
                          <div class="checkbox-column" [formGroupName]="rowIndex">
                            <mat-checkbox color="primary" (click)="$event.stopPropagation();"
                              (change)="onCheckboxChangeFn($event);" formControlName="is_received"
                              [checked]="isSelected">
                            </mat-checkbox>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" [frozenLeft]="true"
                        prop="variant_sku" name="SKU" [width]="80">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" [sortable]="false"
                        prop="product_desc" name="Product Description" [width]="230">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <!-- Barcode number and batch number -->
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="barcode_number"
                        name="Barcode Number" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="skuData[rowIndex]?.barcode">
                              {{value}}
                            </span>
                            <input (input)="getGTIN(rowIndex,'poProducts')" *ngIf="!skuData[rowIndex]?.barcode"
                              autocomplete="off" autofocus class="max-width" maxlength="50" [value]="value"
                              formControlName="barcode_number" appRemoveSpace />
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.poProducts.at(rowIndex).controls.barcode_number.value && isSubmitted">Barcode
                              is required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="batch_no" name="Batch Number"
                        [width]="150">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <input (input)="getBatch(rowIndex)" autocomplete="off" autofocus class="batch-width"
                              [value]="value" formControlName="batch_no" appRemoveSpace />
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.poProducts.at(rowIndex).controls.batch_no.value && isSubmitted">Batch
                              is required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <!-- Barcode number and batch number -->
                      <!-- THC CBD -->
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="thc" name="THC" [width]="90">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <input autocomplete="off" autofocus class="thc-cbd-width" [value]="value"
                              formControlName="thc" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="cbd" name="CBD" [width]="90">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <input autocomplete="off" autofocus class="thc-cbd-width" [value]="value"
                              formControlName="cbd" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <!-- THC CBD -->

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="stock_price"
                        name="Purchase <br/>Price<br/> per unit($)" [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              ${{value|number : '1.2-2'}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="selling_price"
                        name="Selling <br/>Price<br/> per unit($)" [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div fxLayout="row">
                            <div>$</div>&nbsp;
                            <div [formGroupName]="rowIndex">
                              <input autocomplete="off" autofocus appTwoDigitDecimaNumber class="min-width"
                                [value]="value" (input)="stockprice(rowIndex,'poProducts')"
                                onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}"
                                formControlName="selling_price" type="text" />
                            </div>
                          </div>
                          <span class="mat-text-warn"
                            *ngIf="!purchaseForm.controls.poProducts.at(rowIndex).controls.selling_price.value && isSubmitted">Required</span>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="special_price"
                        name="Special <br/>Price<br/> per unit($)" [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div fxLayout="row">
                            <div>$</div>&nbsp;
                            <div [formGroupName]="rowIndex">
                              <input autocomplete="off" autofocus appTwoDigitDecimaNumber class="min-width"
                                [value]="value" onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}"
                                formControlName="special_price" type="text" />
                            </div>
                          </div>
                          <span class="mat-text-warn"
                            *ngIf="!purchaseForm.controls.poProducts.at(rowIndex).controls.special_price.value && isSubmitted">Required</span>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="margin"
                        name="Profit Margin(%)" [width]="150">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div fxLayout="row">
                            <div [formGroupName]="rowIndex">
                              <input autocomplete="off" autofocus (input)="margin(rowIndex,'poProducts')" type="text"
                                appTwoDigitDecimaNumber class="min-width" [value]="value" formControlName="margin"
                                min="0" max="100"
                                onKeyUp="if(this.value==100.){this.value=100};while(this.value>100){this.value = this.value.slice(0, -1)};" />
                            </div>
                            &nbsp;<div>%</div>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="no_of_package"
                        name="case quantity" [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <input (keypress)="utility.numberOnlyValue($event)" (input)="change_qty(rowIndex)"
                              class="min-width" autocomplete="off" maxlength="10" [value]="value"
                              formControlName="no_of_package" />
                          </div>
                          <span class="mat-text-warn"
                            *ngIf="!purchaseForm.controls.poProducts.at(rowIndex).controls.no_of_package.value && isSubmitted">Required</span>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="actual_qty"
                        name="Product Quantity" [width]="100">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value}}
                            </span>
                            <!-- <input autocomplete="off" autofocus type="number" class="min-width" [value]="value"
                              formControlName="actual_qty" /> -->
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="product_category"
                        name="product category" [width]="150">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="variant_size" name="Size"
                        [flexGrow]="1.5">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <!-- <ngx-datatable-column class="hidden-column "  [resizeable]="false" [sortable]="false" prop="storage_id" name="Warehouse" -->
                        <!-- [width]="200"> -->
                        <ng-template class="hidden-column " ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div class="hidden-column " [formGroupName]="rowIndex">
                            <mat-option class="hidden-column " [value]="this.tempWarehouse.storage_id">{{ this.tempWarehouse.name }}
                            </mat-option>
                             
                          </div>
                        </ng-template>
                        <!-- <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <mat-select formControlName="storage_id" placeholder="Warehouse"
                              [disableOptionCentering]="true">
                              <mat-option *ngFor="let wh of warehouse" [value]="wh.storage_id">{{ wh.name }}
                              </mat-option>
                            </mat-select>
                          </div>
                        </ng-template> -->
                      <!-- </ngx-datatable-column> -->

                    </ngx-datatable>
                  </div>
                </mat-card>
              </div>
            </div>
            <div fxFlex="2" fxFlex.sm="2.5" fxFlex.md="2">
            </div>
          </div>
        </div>

        <!------------- Cannabis Products---------->
        <div id="section4" *ngIf="this.purchaseForm.controls?.cannabisProducts?.value.length > 0">
          <div class="section-content" fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="0.5%"
            fxLayoutAlign="center">
            <div fxFlex="5" fxFlex.md="5" fxFlex.sm="5" fxFlex.xs="0">
            </div>
            <div fxFlex="92.5" fxFlex.sm="92.5" fxFlex.md="92.5">
              <div class="" formArrayName="cannabisProducts">
                <h2 layout-margin>Cannabis</h2>
                <mat-card style="padding:0px; overflow: auto;">
                  <div>
                    <ngx-datatable #myDatatable class="material product_table" [headerHeight]="60"
                      [ngStyle]="{'height':cannabis_dynamicHeight}" [limit]="10" [columnMode]="'force'"
                      [scrollbarH]="true" [footerHeight]="0" [rowHeight]="48" [scrollbarV]="true"
                      [rows]="this.purchaseForm.controls.cannabisProducts.value">

                      <!-- <ngx-datatable-column name="" [frozenLeft]="true" [sortable]="false" [draggable]="false"
                        [resizeable]="false" [width]="150" [maxWidth]="60" [minWidth]="50">
                        <ng-template ngx-datatable-header-template let-allRowsSelected="allRowsSelected"
                          let-selectFn="selectFn">
                        </ng-template>
                        <ng-template ngx-datatable-cell-template ngx-datatable-cell-template let-row="row"
                          let-expanded="expanded" let-value="value" let-rowIndex="rowIndex" let-isSelected="isSelected"
                          let-onCheckboxChangeFn="onCheckboxChangeFn">
                          <div class="checkbox-column" [formGroupName]="rowIndex">
                            <mat-checkbox color="primary" (click)="$event.stopPropagation();"
                              (change)="onCheckboxChangeFn($event);" formControlName="is_received"
                              [checked]="isSelected">
                            </mat-checkbox>
                          </div>
                        </ng-template>
                      </ngx-datatable-column> -->

                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="product_name"
                        name="Product Name" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="variant_name"
                        name="Variant Name" [frozenLeft]="true" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="variant_sku"
                        name="Variant SKU" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" prop="value_added" name="qty" [width]="150">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-value_added']">
                              {{value}}
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-value_added']" type="number"
                              (keypress)="utility.numberOnly($event)" class="min-width" [value]="value"
                              formControlName="value_added" (input)="totalQty(rowIndex,'cannabisProducts')" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" prop="actual_qty" name="Actual Quantity" [width]="150">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-value_added']">
                              {{value}}
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-value_added']" type="number"
                              (keypress)="utility.numberOnly($event)" class="min-width" [value]="value"
                              formControlName="actual_qty" />

                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" prop="batch" name="Batch" [width]="150">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-batch']">
                              {{value}}
                            </span>
                            <input class="min-width" autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-batch']"
                              type="text" [value]="value" formControlName="batch" appRemoveSpace />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" prop="storage_id" name="Warehouse" [flexGrow]="2.5">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <mat-select [attr.disabled]="!editing[rowIndex + '-storage_id']"
                              formControlName="storage_id" placeholder="Warehouse" [disableOptionCentering]="true">
                              <mat-option *ngFor="let wh of warehouse" [value]="wh.storage_id">{{ wh.name }}
                              </mat-option>
                            </mat-select>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" prop="stock_price" [sortable]="false"
                        name="Purchase price per unit($)" [flexGrow]="1.5">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-stock_price']">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-stock_price']" type="number"
                              (keypress)="utility.numberAndDotOnly($event,this.purchaseForm.controls['cannabisProducts'].controls[rowIndex].controls['stock_price'].value)"
                              class="min-width" [value]="value" (input)="stockprice(rowIndex,'cannabisProducts')"
                              formControlName="stock_price"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="cost" name="Extended price"
                        [flexGrow]="1.5">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              ${{(row['stock_price']*row['value_added'])| number : '1.2-2'}}
                            </span>

                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="selling_price"
                        name="Selling Price per unit($)" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-total_selling_price']">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-total_selling_price']"
                              type="number"
                              (keypress)="utility.numberAndDotOnly($event,this.purchaseForm.controls['cannabisProducts'].controls[rowIndex].controls['selling_price'].value)"
                              (input)="stockprice(rowIndex,'cannabisProducts')" class="min-width" [value]="value"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}"
                              formControlName="selling_price" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="special_price"
                        name="Special Price per unit($)" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-special_price']">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-special_price']"
                              type="number"
                              (keypress)="utility.numberAndDotOnly($event,this.purchaseForm.controls['cannabisProducts'].controls[rowIndex].controls['special_price'].value)"
                              class="min-width" [value]="value"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}"
                              formControlName="special_price" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="margin"
                        name="Profit Margin(%)" [width]="150">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-margin']">
                              --
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex + '-margin']"
                              (keypress)="utility.numberAndDotOnly($event,this.purchaseForm.controls['cannabisProducts'].controls[rowIndex].controls['margin'].value)"
                              (input)="margin(rowIndex,'cannabisProducts')" type="number" class="min-width"
                              [value]="value" formControlName="margin" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column name="ACTION" [sortable]="false" width="70" [resizeable]="false"
                        [width]="200">
                        <ng-template let-row="row" let-value="value" let-rowIndex="rowIndex"
                          ngx-datatable-cell-template>
                          <button mat-icon-button (click)="edit_row(rowIndex);isEditable[rowIndex] = true"
                            *ngIf="!isEditable[rowIndex]">
                            <mat-icon>edit</mat-icon>
                          </button>
                          <button mat-icon-button type="button"
                            (click)="updateValue(['product_name','variant_name','value_added','stock_price','selling_price','batch','storage_id','cost','total_selling_price','special_price','margin'], rowIndex);isEditable[rowIndex] = false;focusOnSearch()"
                            *ngIf="isEditable[rowIndex]">
                            <mat-icon>add_box</mat-icon>
                          </button>
                          <button mat-icon-button type="button" (click)="deleteVariant(rowIndex,'cannabisProducts')">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </ng-template>
                      </ngx-datatable-column>
                    </ngx-datatable>
                  </div>
                </mat-card>
                <span style="color: green;" *ngIf="isScanning">
                  <mat-icon class="report-header-button">view_column</mat-icon>Scanning Enbled
                </span>
                <span style="color: red;" *ngIf="!isScanning">
                  <mat-icon class="report-header-button">view_column</mat-icon>Scanning Disabled
                </span>
              </div>
            </div>
            <div fxFlex="2.5" fxFlex.sm="2.5" fxFlex.md="2.5">
            </div>
          </div>
        </div>

        <!------------- Cannabis Accessories Products---------->
        <div id="section4" *ngIf="this.purchaseForm.controls?.cannabisProductsAccessories?.value.length > 0">
          <div class="section-content" fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="0.5%"
            fxLayoutAlign="center">
            <div fxFlex="2" fxFlex.md="2" fxFlex.sm="5" fxFlex.xs="10%">
            </div>
            <div fxFlex="96" fxFlex.sm="75" fxFlex.md="96" fxFlex.xs="80%">
              <div class="" formArrayName="cannabisProductsAccessories">
                <h2 layout-margin>Cannabis Accessories</h2>
                <mat-card style="padding:0px; overflow: auto;">
                  <div>
                    <ngx-datatable #myDatatable class="material product_table" [headerHeight]="60"
                      [ngStyle]="{'height':cannabis_accessories_dynamicHeight}" [limit]="10" [columnMode]="'force'"
                      [scrollbarH]="true" [footerHeight]="0" [rowHeight]="48" [scrollbarV]="true"
                      [rows]="this.purchaseForm.controls.cannabisProductsAccessories.value">
                      <!-- <ngx-datatable-column name="" [frozenLeft]="true" [sortable]="false" [draggable]="false"
                        [resizeable]="false" [width]="50" [maxWidth]="40" [minWidth]="30">
                        <ng-template ngx-datatable-header-template let-allRowsSelected="allRowsSelected"
                          let-selectFn="selectFn">
                        </ng-template>
                        <ng-template ngx-datatable-cell-template ngx-datatable-cell-template let-row="row"
                          let-expanded="expanded" let-value="value" let-rowIndex="rowIndex" let-isSelected="isSelected"
                          let-onCheckboxChangeFn="onCheckboxChangeFn">
                          <div class="checkbox-column" [formGroupName]="rowIndex">
                            <mat-checkbox color="primary" (click)="$event.stopPropagation();"
                              (change)="onCheckboxChangeFn($event);" formControlName="is_received"
                              [checked]="isSelected">
                            </mat-checkbox>
                          </div>
                        </ng-template>
                      </ngx-datatable-column> -->
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="variant_sku" name="SKU"
                        [width]="135">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="product_name"
                        name="Product Name" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="variant_name"
                        name="Variant Name" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <!-- <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="barcodes" name="barcode" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span>
                              {{value ? value.split(',')[0] : '--'}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column> -->

                      <ngx-datatable-column [resizeable]="false" prop="value_added" name="qty*" [width]="85">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <div fxLayout="row" class="cell-data">
                              <span *ngIf="!editing[rowIndex + '-value_added']">
                                {{value}}
                              </span>
                              <input autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-value_added']"
                                type="number" min="0" (keypress)="utility.numberOnly($event)" class="min-width"
                                [value]="value" formControlName="value_added"
                                (input)="total_product_qty(rowIndex,'cannabisProductsAccessories')" />
                            </div>
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.cannabisProductsAccessories.at(rowIndex).controls.value_added.value && isSubmitted">Required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <!-- purchase price per unit / purchase price / stock price -->
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="stock_price"
                        name="Purchase price per unit($)*" [width]="145">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <!-- <div fxLayout="row"> -->
                            <span *ngIf="!editing[rowIndex + '-stock_price'] && value">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-stock_price']" type="text"
                              min="0" appTwoDigitDecimaNumber
                              (input)="stockprice(rowIndex,'cannabisProductsAccessories')" class="min-width"
                              [value]="value" formControlName="stock_price"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}" />
                            <!-- </div> -->
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.cannabisProductsAccessories.at(rowIndex).controls.stock_price.value && isSubmitted">Required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <!-- purchase price per lot / extended price -->
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="cost" name="Extended Price"
                        [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span>
                              ${{(row['stock_price']*row['value_added'])| number : '1.2-2'}}
                            </span>

                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="selling_price"
                        name="Selling Price per unit($)*" [width]="130">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <!-- <div fxLayout="row"> -->
                            <span *ngIf="!editing[rowIndex + '-total_selling_price']">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus
                              (input)="stockprice(rowIndex,'cannabisProductsAccessories')" type="text" min="0"
                              appTwoDigitDecimaNumber *ngIf="editing[rowIndex+ '-total_selling_price']"
                              class="min-width" [value]="value"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}"
                              formControlName="selling_price" />
                            <!-- </div> -->
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.cannabisProductsAccessories.at(rowIndex).controls.selling_price.value && isSubmitted">Required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="special_price"
                        name="Special Price per unit($)*" [width]="130">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <!-- <div fxLayout="row"> -->
                            <span *ngIf="!editing[rowIndex + '-special_price']">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus
                              type="text" min="0"
                              appTwoDigitDecimaNumber *ngIf="editing[rowIndex+ '-special_price']"
                              class="min-width" [value]="value"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}"
                              formControlName="special_price" />
                            <!-- </div> -->
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.cannabisProductsAccessories.at(rowIndex).controls.special_price.value && isSubmitted">Required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="margin"
                        name="Profit Margin(%)" [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span *ngIf="!editing[rowIndex + '-margin']">
                              {{value}}
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex + '-margin']"
                              (input)="margin(rowIndex,'cannabisProductsAccessories')" appTwoDigitDecimaNumber
                              type="text" class="min-width" [value]="value" formControlName="margin" min="0" max="100"
                              onKeyUp="if(this.value==100.){this.value=100};while(this.value>100){this.value = this.value.slice(0, -1)};" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="barcode_number"
                        name="Barcode Number" [width]="160">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span *ngIf="!editing[rowIndex + '-barcode_number']">
                              {{row.barcodes ? row['barcodes'].split(',').length ?  row['barcodes'].split(',')[row['barcodes'].split(',').length - 1] : 'n' : ''}}
                            </span>
                            <input *ngIf="editing[rowIndex + '-barcode_number']"
                              (input)="getGTIN(rowIndex,'cannabisProductsAccessories')" autocomplete="off"
                              [matAutocomplete]="poAuto" class="max-width" maxlength="50"
                              formControlName="barcode_number" appRemoveSpace />
                            <mat-autocomplete #poAuto="matAutocomplete">
                              <mat-option
                                *ngFor="let option of (row['barcodes'] && row['barcodes'].split(',') != ',' ? row['barcodes'].split(',') : [])"
                                [value]="option"
                                (onSelectionChange)="changeBarcode(rowIndex,'cannabisProductsAccessories')">
                                {{option}}
                              </mat-option>
                            </mat-autocomplete>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <!-- <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="package_capacity" name="case quantity" [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-package_capacity']">
                              {{value}}
                            </span>
                            <input *ngIf="editing[rowIndex + '-package_capacity']" (keypress)="utility.numberOnlyValue($event)" (input)="total_product_qty(rowIndex,'cannabisProductsAccessories')" class="min-width" autocomplete="off" maxlength="10" [value]="value" formControlName="package_capacity" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="actual_qty" name="Product Quantity"
                      [width]="100">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                              <span>
                                {{value}}
                              </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column> -->
                      <ngx-datatable-column name="ACTION" [frozenRight]="true" [sortable]="false" width="70"
                        [resizeable]="false" [width]="120">
                        <ng-template let-row="row" let-value="value" let-rowIndex="rowIndex"
                          ngx-datatable-cell-template>
                          <button class="action_btn" mat-icon-button
                            (click)="edit_row(rowIndex);isEditable[rowIndex] = true" *ngIf="!isEditable[rowIndex]">
                            <mat-icon>edit</mat-icon>
                          </button>
                          <button class="action_btn" mat-icon-button type="button"
                            (click)="updateValue(['product_name','variant_name','value_added','stock_price','selling_price','special_price','batch','storage_id','cost','total_selling_price','margin','package_capacity','barcode_number'], rowIndex);isEditable[rowIndex] = false"
                            *ngIf="isEditable[rowIndex]">
                            <mat-icon>add_box</mat-icon>
                          </button>
                          <button class="action_btn" mat-icon-button type="button"
                            (click)="deleteVariant(rowIndex,'cannabisProductsAccessories')">
                            <mat-icon>delete</mat-icon>
                          </button>
                          <button class="action_btn"
                            *ngIf="!isEditable[rowIndex] && row.barcodes && row.barcodes != ','" mat-icon-button
                            type="button" (click)="printBarcode(rowIndex,row.variant_id,'cannabisProductsAccessories')">
                            <mat-icon>print</mat-icon>
                          </button>
                        </ng-template>
                      </ngx-datatable-column>
                    </ngx-datatable>
                  </div>
                </mat-card>
                <span style="color: green;" *ngIf="isScanning">
                  <mat-icon class="report-header-button">view_column</mat-icon>Scanning Enbled
                </span>
                <span style="color: red;" *ngIf="!isScanning">
                  <mat-icon class="report-header-button">view_column</mat-icon>Scanning Disabled
                </span>
              </div>
            </div>
            <div fxFlex="2" fxFlex.sm="20" fxFlex.md="2" fxFlex.xs="10%">
            </div>
          </div>
        </div>

        <!------------- Non-Cannabis Products---------->
        <div id="section5" *ngIf="this.purchaseForm.controls?.noncannabisProducts?.value.length > 0">
          <div class="section-content" fxLayout="row" fxLayout.xs="column" fxLayoutWrap fxLayoutGap="0.5%"
            fxLayoutAlign="center">
            <div fxFlex="2" fxFlex.md="2" fxFlex.sm="5" fxFlex.xs="10%">
            </div>
            <div fxFlex="96" fxFlex.sm="75" fxFlex.md="96" fxFlex.xs="80%">
              <div class="" formArrayName="noncannabisProducts">
                <!-- my search bar -->
                <div fxLayout="row">
                  <div fxFlex="50%">
                    <h2 layout-margin>Non-Cannabis / Others</h2>
                  </div>
                  <div fxFlex="50%">
                    <div class="searchbar-div margin-top-30" fxLayout="row" fxLayoutWrap fxLayoutAlign="center">
                      <div class="po-search-input" fxFlex="100%" fxFlex.md="100%" fxFlex.lg="100%" fxFlex.sm="100%"
                        fxFlex.xs="100%">
                        <img class="Search-icon" alt="Search" src="../../assets/icon/search.png">
                        <input class="Search" placeholder="Search By #PO" (input)="applyFilterProducts($event)">
                        <span class="result-count">Results</span>
                      </div>
                    </div>
                  </div>
                </div>

                <mat-card style="padding:0px; overflow: auto;" *ngIf="noncannabisProducts.length>0">
                  <div>
                    <ngx-datatable #myDatatable class="material product_table" [headerHeight]="60"
                      [ngStyle]="{'height':non_cannabis_dynamicHeight}" [limit]="10" [columnMode]="'force'"
                      [scrollbarH]="true" [footerHeight]="0" [rowHeight]="48" [scrollbarV]="true"
                      [rows]="noncannabisProducts">
                      <!-- <ngx-datatable-column name="" [frozenLeft]="true" [sortable]="false" [draggable]="false"
                        [resizeable]="false" [width]="50" [maxWidth]="40" [minWidth]="30">
                        <ng-template ngx-datatable-header-template let-allRowsSelected="allRowsSelected"
                          let-selectFn="selectFn">
                        </ng-template>
                        <ng-template ngx-datatable-cell-template ngx-datatable-cell-template let-row="row"
                          let-expanded="expanded" let-value="value" let-rowIndex="rowIndex" let-isSelected="isSelected"
                          let-onCheckboxChangeFn="onCheckboxChangeFn">
                          <div class="checkbox-column" [formGroupName]="rowIndex">
                            <mat-checkbox color="primary" (click)="$event.stopPropagation();"
                              (change)="onCheckboxChangeFn($event);" formControlName="is_received"
                              [checked]="isSelected">
                            </mat-checkbox>
                          </div>
                        </ng-template>
                      </ngx-datatable-column> -->
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="variant_sku" name="SKU"
                        [width]="135">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="product_name"
                        name="Product Name" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [frozenLeft]="true" prop="variant_name"
                        name="Variant Name" [width]="200">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span>
                              {{value}}
                            </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" prop="value_added" name="qty*" [width]="85">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <div fxLayout="row">
                              <span *ngIf="!editing[rowIndex + '-value_added']">
                                {{value}}
                              </span>
                              <input autocomplete="off" autofocus *ngIf="editing[rowIndex+ '-value_added']"
                                type="number" min="0" class="min-width" [value]="value" formControlName="value_added"
                                (keypress)="utility.numberOnly($event)"
                                (input)="total_product_qty(rowIndex,'noncannabisProducts')" />
                            </div>
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.noncannabisProducts.at(rowIndex).controls.value_added.value && isSubmitted">Required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <!-- purchase price per unit / purchase price / stock price -->
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="stock_price"
                        name="Purchase price per unit($)*" [width]='143'>
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <!-- <div fxLayout="row"> -->
                            <span *ngIf="!editing[rowIndex + '-stock_price'] && value">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus (input)="stockprice(rowIndex,'noncannabisProducts')"
                              type="text" min="0" appTwoDigitDecimaNumber *ngIf="editing[rowIndex+ '-stock_price']"
                              class="min-width" [value]="value" formControlName="stock_price"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}" />
                            <!-- </div> -->
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.noncannabisProducts.at(rowIndex).controls.stock_price.value && isSubmitted">Required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <!-- purchase price per lot / extended price -->
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="cost" name="Extended Price"
                        [width]='120'>
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span>
                              ${{(row['stock_price']*row['value_added'])| number : '1.2-2'}}
                            </span>

                          </div>
                        </ng-template>
                      </ngx-datatable-column>

                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="selling_price"
                        name="Selling Price per unit($)*" [width]="130">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <!-- <div fxLayout="row"> -->
                            <span *ngIf="!editing[rowIndex + '-total_selling_price']">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus (input)="stockprice(rowIndex,'noncannabisProducts')"
                              type="text" min="0" appTwoDigitDecimaNumber
                              *ngIf="editing[rowIndex+ '-total_selling_price']" class="min-width" [value]="value"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}"
                              formControlName="selling_price" />
                            <!-- </div> -->
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.noncannabisProducts.at(rowIndex).controls.selling_price.value && isSubmitted">Required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="special_price"
                        name="Special Price per unit($)*" [width]="130">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <!-- <div fxLayout="row"> -->
                            <span *ngIf="!editing[rowIndex + '-special_price']">
                              ${{value | number : '1.2-2'}}
                            </span>
                            <input autocomplete="off" autofocus 
                              type="text" min="0" appTwoDigitDecimaNumber
                              *ngIf="editing[rowIndex+ '-special_price']" class="min-width" [value]="value"
                              onKeyUp="if(this.value == ' '){while(this.value){this.value = this.value.slice(0, -1)};}"
                              formControlName="special_price" />
                            <!-- </div> -->
                            <span class="mat-text-warn"
                              *ngIf="!purchaseForm.controls.noncannabisProducts.at(rowIndex).controls.special_price.value && isSubmitted">Required</span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="margin"
                        name="Profit Margin(%)" [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span *ngIf="!editing[rowIndex + '-margin']">
                              --
                            </span>
                            <input autocomplete="off" autofocus *ngIf="editing[rowIndex + '-margin']"
                              (input)="margin(rowIndex,'noncannabisProducts')" appTwoDigitDecimaNumber type="text"
                              class="min-width" [value]="value" formControlName="margin" min="0" max="100"
                              onKeyUp="if(this.value==100.){this.value=100};while(this.value>100){this.value = this.value.slice(0, -1)};" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="barcode_number"
                        name="Barcode Number" [width]="160">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex" class="cell-data">
                            <span *ngIf="!editing[rowIndex + '-barcode_number']">
                              {{row.barcodes ? row['barcodes'].split(',').length ?  row['barcodes'].split(',')[row['barcodes'].split(',').length - 1] : 'n' : ''}}
                            </span>
                            <input *ngIf="editing[rowIndex + '-barcode_number']"
                              (input)="getGTIN(rowIndex,'noncannabisProducts')" autocomplete="off"
                              [matAutocomplete]="poAuto" class="max-width" maxlength="50"
                              formControlName="barcode_number" appRemoveSpace />
                            <mat-autocomplete #poAuto="matAutocomplete">
                              <mat-option
                                *ngFor="let option of (row['barcodes'] && row['barcodes'].split(',') != ',' ? row['barcodes'].split(',') : [])"
                                [value]="option" (onSelectionChange)="changeBarcode(rowIndex,'noncannabisProducts')">
                                {{option}}
                              </mat-option>
                            </mat-autocomplete>
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <!-- <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="package_capacity" name="case quantity" [width]="120">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                            <span *ngIf="!editing[rowIndex + '-package_capacity']">
                              {{value}}
                            </span>
                            <input *ngIf="editing[rowIndex + '-package_capacity']" (keypress)="utility.numberOnlyValue($event)" (input)="total_product_qty(rowIndex,'noncannabisProducts')" class="min-width" autocomplete="off" maxlength="10" [value]="value" formControlName="package_capacity" />
                          </div>
                        </ng-template>
                      </ngx-datatable-column>
                      <ngx-datatable-column [resizeable]="false" [sortable]="false" prop="actual_qty" name="Product Quantity"
                      [width]="100">
                        <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex" let-value="value"
                          let-row="row">
                          <div [formGroupName]="rowIndex">
                              <span>
                                {{value}}
                              </span>
                          </div>
                        </ng-template>
                      </ngx-datatable-column> -->
                      <ngx-datatable-column name="ACTION" [frozenRight]="true" [sortable]="false" [resizeable]="false"
                        [width]="120">
                        <ng-template let-row="row" let-value="value" let-rowIndex="rowIndex"
                          ngx-datatable-cell-template>
                          <button class="action_btn" mat-icon-button
                            (click)="edit_row(rowIndex);isEditable[rowIndex] = true" *ngIf="!isEditable[rowIndex]">
                            <mat-icon>edit</mat-icon>
                          </button>
                          <button class="action_btn" mat-icon-button type="button"
                            (click)="updateValue(['product_name','variant_name','value_added','stock_price','selling_price','special_price','batch','storage_id','cost','total_selling_price','margin','package_capacity','barcode_number'], rowIndex);isEditable[rowIndex] = false"
                            *ngIf="isEditable[rowIndex]">
                            <mat-icon>add_box</mat-icon>
                          </button>
                          <button class="action_btn" mat-icon-button type="button"
                            (click)="deleteVariant(rowIndex,'noncannabisProducts')">
                            <mat-icon>delete</mat-icon>
                          </button>
                          <button class="action_btn"
                            *ngIf="!isEditable[rowIndex] && row.barcodes && row.barcodes != ','" mat-icon-button
                            type="button" (click)="printBarcode(rowIndex,row.variant_id,'noncannabisProducts')">
                            <mat-icon>print</mat-icon>
                          </button>
                        </ng-template>
                      </ngx-datatable-column>
                    </ngx-datatable>
                  </div>
                </mat-card>
                <span style="color: green;" *ngIf="isScanning">
                  <mat-icon class="report-header-button">view_column</mat-icon>Scanning Enbled
                </span>
                <span style="color: red;" *ngIf="!isScanning">
                  <mat-icon class="report-header-button">view_column</mat-icon>Scanning Disabled
                </span>
              </div>
            </div>
            <div fxFlex="2" fxFlex.sm="20" fxFlex.md="2" fxFlex.xs="10%">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>